---
title: jvm-05-class文件结构
date: 2018-02-25 09:26:39
tags: jvm笔记
---

概览： class类文件结构、字节码指令

# 类文件结构

class文件是8位字节为单位的二进制流，如果使用16进制打开，2个16进制数字为1个字节。

1个字节=8个比特位，1个16进制数字=4个比特位。

只有两种数据类型：无符号数和表。  

无符号数以u1，u2，u4，u8代表1、2、4、8字节的无符号数，可以用来描述数字、索引、数量值或utf-8编码的字符串。   

表由多个无符号数或其他表构成的复核数据类型，用于描述层次关系的复合结构数据。

示例代码：

```java
public class HelloJvm {

    int i = 0;

    private int incr() {
        i++;
        return i;
    }
}
```

使用16进制打开的class文件：

{% asset_img cafebabe.png %}

## 魔数与class文件版本

头4个字节为魔数，`0xCAFEBABE`。紧接着的4个字节为class文件版本号，`0x0034`为版本52即jdk8。

## 常量池

常量池入口为u2类型的容量计数值，从1开始。 

每种常量池项目类型有着不同的数据结构，相同点是第一个数据项为tag表明是什么项目类型。

可以用 `javap -verbose` 将常量池计算出来

{% asset_img javap.png %}

## 类索引、父类索引和接口索引集合

类索引u2+父类索引u2+接口计数器u2+接口索引

## 字段表集合

字段表用于描述接口或者类中声明的变量。包括信息有：

* 字段作用域 public private protected
* 实例变量还是类变量 static
* 可变性 final
* 并发可见性 volatile
* 可否被序列化
* 字段数据类型 基本类型、对象、数组

字段表结构

| 类型           | 名称                              | 数量 |
| -------------- | --------------------------------- | ---- |
| u2             | access_flags 限定符               | 1    |
| u2             | name_index 简单名称               | 1    |
| u2             | descriptor_index 字段和方法描述符 | 1    |
| u2             | attributes_count 属性表计数       | 1    |
| attribute_info | attributes 属性                   | 1    |

**简单名称**：字段的变量名或方法名称

**全限定名称**：包括包路径的全称如 `com/stu/jvm/TestClass;`

**方法和字段描述符**：用来描述字段的数据类型、方法的参数列表和返回值。数组类型每一维度前置一个 `[`字符。
用描述符描述方法时，先参数列表，后返回值顺序描述

| 标识字符 | 含义                          |
| -------- | ----------------------------- |
| B        | byte                          |
| C        | char                          |
| D        | double                        |
| F        | float                         |
| I        | int                           |
| J        | long                          |
| S        | short                         |
| Z        | boolean                       |
| V        | void                          |
| L        | 对象类型，如Ljava/lang/Object |

## 方法表集合

方法表结构同字段表一样，仅访问标识可选项有所区别。

## 属性表集合

在class文件、字段表、方法表都可以有自己的属性表集合，用于描述场景专有信息。其中关键部分属性：

| 属性               | 使用位置           | 含义                                         |
| ------------------ | ------------------ | -------------------------------------------- |
| Code               | 方法表             | Java代码编译后的字节码指令                   |
| Exceptions         | 方法表             | 方法抛出的异常                               |
| LineNumberTable    | Code属性           | Java源码行号和字节码指令的对应关系           |
| LocalVariableTable | Code属性           | 方法局部变量描述                             |
| SourceFile         | 类文件             | 源文件名称                                   |
| ConstantValue      | 字段表             | final关键字定义的常量值                      |
| InnerClasses       | 类文件             | 内部类列表                                   |
| Signature          | 类、方法表、字段表 | 用于支持泛型情况的方法签名，记录泛型签名信息 |


# 字节码指令简介
